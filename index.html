<!DOCTYPE html>
<html lang="ru">
<head>
    <meta name="google-site-verification" content="S4yj26laybYjHTBWA5u_2ey7dSgZ4F_5I22864VlCMU" />
    
    <!-- PWA: manifest и цвет темы. Manifest должен быть отдельным файлом! -->
    <link rel="manifest" href="manifest.json">
    <meta name="theme-color" content="#6366f1">
    
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Neuron Study</title>
    
    <!-- External Dependencies -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <!-- СТИЛИЗЦИЯ (ВСТАВЛЕНО ИЗ style.css) -->
    <style>
        /* Neuron Ecosystem Styles */
        :root {
            --primary: #6366f1;
            --primary-dark: #4f46e5;
            --secondary: #8f94fb;
            --bg: #0f0f2a;
            --text-color: #e5e7eb;
            --sidebar-bg: #1a1a2e;
        }

        body {
            background-color: var(--bg);
            color: var(--text-color);
            font-family: 'Arial', sans-serif;
            margin: 0;
            padding-top: 60px; /* Offset for fixed header */
            overflow-x: hidden; /* Предотвращение горизонтального скролла */
        }

        /* ---------------------------------------------------- */
        /* HEADER & NAVIGATION STYLES (П.3 - Центрирование) */
        /* ---------------------------------------------------- */

        .header {
            background-color: var(--sidebar-bg);
            color: white;
            height: 60px;
            display: flex;
            align-items: center;
            position: fixed;
            width: 100%;
            top: 0;
            left: 0;
            z-index: 100;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.5);
        }
        
        /* Меню слева, Кнопка справа, Заголовок по центру */
        .header .menu-icon {
            cursor: pointer;
            font-size: 1.5rem;
            padding: 0 20px;
            z-index: 101; /* Поверх сайдбара */
        }

        .header h1 {
            margin: 0 auto; /* Центрирование */
            font-size: 1.5rem;
            position: absolute;
            left: 50%;
            transform: translateX(-50%);
        }

        /* Navigation Auth Button */
        .nav-auth-btn {
            position: absolute; 
            right: 15px; 
            background-color: transparent; 
            color: #fff;
            border: 2px solid #57a8ff; 
            padding: 8px 15px;
            border-radius: 6px;
            cursor: pointer;
            font-weight: bold;
            text-transform: uppercase;
            transition: all 0.3s ease; 
            z-index: 100;
        }

        .nav-auth-btn:hover {
            background-color: #57a8ff; 
            box-shadow: 0 0 10px #57a8ff; 
            color: #111;
        }

        /* ---------------------------------------------------- */
        /* SIDEBAR STYLES (П.1 - Боковая панель) */
        /* ---------------------------------------------------- */
        .nav-sidebar {
            position: fixed;
            top: 0;
            left: -300px; /* Скрыто по умолчанию */
            width: 280px;
            height: 100%;
            background-color: var(--sidebar-bg);
            padding-top: 60px; /* Отступ от шапки */
            transition: left 0.3s ease-in-out;
            z-index: 99;
            overflow-y: auto;
            border-right: 1px solid #333;
        }
        
        /* Класс для открытого состояния */
        .nav-sidebar.open {
            left: 0;
            box-shadow: 5px 0 15px rgba(0, 0, 0, 0.7); /* Тень только при открытии */
        }

        .sidebar-item {
            padding: 15px 20px;
            cursor: pointer;
            font-size: 1.1rem;
            border-bottom: 1px solid #2b2b3b;
            transition: background-color 0.2s;
        }

        .sidebar-item:hover, .sidebar-item.active {
            background-color: #2b2b3b;
            color: var(--primary);
        }

        .sidebar-item i {
            margin-right: 10px;
        }
        
        /* Затемнение контента */
        #overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
            z-index: 98;
            display: none;
            cursor: pointer;
        }

        /* ---------------------------------------------------- */
        /* MAIN CONTENT VIEWS */
        /* ---------------------------------------------------- */
        .content {
            padding: 20px;
            max-width: 1200px;
            margin: 0 auto;
        }

        .content-view {
            display: none; /* Все скрыты по умолчанию */
            padding-top: 20px;
        }
        .content-view.active {
            display: block;
        }
        
        /* ---------------------------------------------------- */
        /* SCHEDULER & DAY SECTION */
        /* ---------------------------------------------------- */

        .day-section {
            background-color: #1e1e2e;
            border-radius: 8px;
            padding: 20px;
            margin-bottom: 20px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.3);
            position: relative;
        }

        .day-title {
            color: var(--secondary);
            font-size: 1.8rem;
            margin-bottom: 10px;
            border-bottom: 2px solid #333;
            padding-bottom: 5px;
        }

        .edit-btn {
            position: absolute;
            top: 20px;
            right: 20px;
            background-color: var(--primary);
            color: white;
            border: none;
            padding: 8px 15px;
            border-radius: 5px;
            cursor: pointer;
            transition: background-color 0.2s;
        }

        .edit-btn:hover {
            background-color: var(--primary-dark);
        }

        .schedule-placeholder {
            text-align: center;
            color: #777;
            padding: 40px 0;
        }

        .schedule-placeholder i {
            font-size: 3rem;
            display: block;
            margin-bottom: 10px;
        }
        
        /* ---------------------------------------------------- */
        /* NOTES VIEW (П.5 - Заметки) */
        /* ---------------------------------------------------- */

        #notes-view textarea, #notes-view input {
            width: 100%;
            padding: 10px;
            margin-bottom: 15px;
            background: #2b2b3b;
            border: 1px solid #444;
            color: var(--text-color);
            border-radius: 5px;
            box-sizing: border-box;
            resize: vertical;
        }

        #notes-view h3 {
            color: var(--primary);
        }

        .note-card {
            background-color: #1e1e2e;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 10px;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.3);
        }
        .note-card h4 {
            margin-top: 0;
            color: var(--secondary);
        }
        .note-card p {
            margin-bottom: 0;
            font-size: 0.95rem;
        }

        /* ---------------------------------------------------- */
        /* AUTH MODAL STYLES */
        /* ---------------------------------------------------- */

        #auth-container {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: #1e1e2d; 
            padding: 30px;
            border-radius: 10px;
            z-index: 2000;
            box-shadow: 0 0 20px rgba(87, 168, 255, 0.5); 
            max-width: 400px;
            width: 90%;
            text-align: center;
            border: 1px solid #57a8ff;
            animation: fadeIn 0.3s ease-out;
            display: none; /* Скрыто по умолчанию */
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translate(-50%, -60%); }
            to { opacity: 1; transform: translate(-50%, -50%); }
        }

        #auth-container h2 {
            color: var(--primary);
            margin-bottom: 20px;
        }

        #auth-container input {
            width: 100%;
            padding: 10px;
            margin-bottom: 15px;
            background: #2b2b3b;
            border: 1px solid #444;
            color: var(--text-color);
            border-radius: 5px;
            box-sizing: border-box;
        }

        #auth-container button {
            padding: 10px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-weight: bold;
            transition: background-color 0.2s;
            margin: 5px 1%;
        }

        #registerButton, #loginButton {
            background-color: var(--primary);
            color: white;
            width: 48%; 
        }

        #registerButton:hover, #loginButton:hover {
            background-color: var(--primary-dark);
        }

        .close-btn {
            position: absolute;
            top: 5px;
            right: 10px;
            background: none;
            font-size: 1.5rem;
            color: #fff;
            opacity: 0.7;
        }
        
        /* Media Queries for Responsiveness */
        @media (max-width: 600px) {
            .header h1 {
                font-size: 1.2rem;
            }
            .edit-btn {
                position: static;
                margin-top: 10px;
                display: block;
                width: 100%;
            }
            .nav-auth-btn {
                right: 10px;
                top: 10px;
                padding: 6px 12px;
                font-size: 0.8rem;
            }
            #auth-container {
                padding: 20px;
            }
        }
    </style>
</head>

<body class="bg-gray-900 text-white font-sans">
    
    <!-- HEADER -->
    <header class="header">
        <div class="menu-icon" id="menuIcon">
            <i class="fas fa-bars"></i>
        </div>
        <h1>Neuron Study</h1>
        
        <!-- AUTH BUTTON (Visible in the top right corner) -->
        <button id="mainAuthButton" class="nav-auth-btn">
            Войти / Регистрация
        </button>
    </header>

    <!-- SIDEBAR (П.1 - Боковая панель) -->
    <aside class="nav-sidebar" id="navSidebar">
        <div class="sidebar-item active" id="menu-schedule">
            <i class="fas fa-calendar-alt"></i> Расписание
        </div>
        <div class="sidebar-item" id="menu-notes">
            <i class="fas fa-sticky-note"></i> Заметки
        </div>
        <div class="sidebar-item" id="menu-translator">
            <i class="fas fa-language"></i> Переводчик (История)
        </div>
        <div class="sidebar-item" id="menu-about">
            <i class="fas fa-info-circle"></i> О нас
        </div>
        <hr style="border-color: #2b2b3b;">
        <div class="sidebar-item" id="menu-logout" style="color: #ff6b6b; display: none;">
            <i class="fas fa-sign-out-alt"></i> Выйти
        </div>
    </aside>
    
    <!-- OVERLAY for closing sidebar -->
    <div id="overlay"></div>

    <!-- MAIN CONTENT AREA -->
    <div class="content">
        
        <!-- 1. SCHEDULE VIEW (Активно по умолчанию) -->
        <div id="schedule-view" class="content-view active">
            <h2>Ваше учебное расписание</h2>
            <p style="color:#aaa;">Ваши данные расписания сохраняются в облаке (Firestore) при авторизации.</p>
            
            <div id="schedule-content">
                <!-- ПОНЕДЕЛЬНИК -->
                <div class="day-section" data-day="Понедельник">
                    <h2 class="day-title">Понедельник</h2>
                    <button class="edit-btn" onclick="openScheduleEditor('Понедельник')">Редактировать</button>
                    <div class="schedule-placeholder">
                        <i class="far fa-calendar-alt"></i>
                        <p id="schedule-Понедельник">Расписание не заполнено</p>
                    </div>
                </div>

                <!-- ВТОРНИК -->
                <div class="day-section" data-day="Вторник">
                    <h2 class="day-title">Вторник</h2>
                    <button class="edit-btn" onclick="openScheduleEditor('Вторник')">Редактировать</button>
                    <div class="schedule-placeholder">
                        <i class="far fa-calendar-alt"></i>
                        <p id="schedule-Вторник">Расписание не заполнено</p>
                    </div>
                </div>

                <!-- СРЕДА -->
                <div class="day-section" data-day="Среда">
                    <h2 class="day-title">Среда</h2>
                    <button class="edit-btn" onclick="openScheduleEditor('Среда')">Редактировать</button>
                    <div class="schedule-placeholder">
                        <i class="far fa-calendar-alt"></i>
                        <p id="schedule-Среда">Расписание не заполнено</p>
                    </div>
                </div>
                
                <!-- ЧЕТВЕРГ -->
                <div class="day-section" data-day="Четверг">
                    <h2 class="day-title">Четверг</h2>
                    <button class="edit-btn" onclick="openScheduleEditor('Четверг')">Редактировать</button>
                    <div class="schedule-placeholder">
                        <i class="far fa-calendar-alt"></i>
                        <p id="schedule-Четверг">Расписание не заполнено</p>
                    </div>
                </div>
                
                <!-- ПЯТНИЦА -->
                <div class="day-section" data-day="Пятница">
                    <h2 class="day-title">Пятница</h2>
                    <button class="edit-btn" onclick="openScheduleEditor('Пятница')">Редактировать</button>
                    <div class="schedule-placeholder">
                        <i class="far fa-calendar-alt"></i>
                        <p id="schedule-Пятница">Расписание не заполнено</p>
                    </div>
                </div>
                
                <!-- СУББОТА -->
                <div class="day-section" data-day="Суббота">
                    <h2 class="day-title">Суббота</h2>
                    <button class="edit-btn" onclick="openScheduleEditor('Суббота')">Редактировать</button>
                    <div class="schedule-placeholder">
                        <i class="far fa-calendar-alt"></i>
                        <p id="schedule-Суббота">Расписание не заполнено</p>
                    </div>
                </div>
                
                <!-- ВОСКРЕСЕНЬЕ -->
                <div class="day-section" data-day="Воскресенье">
                    <h2 class="day-title">Воскресенье</h2>
                    <button class="edit-btn" onclick="openScheduleEditor('Воскресенье')">Редактировать</button>
                    <div class="schedule-placeholder">
                        <i class="far fa-calendar-alt"></i>
                        <p id="schedule-Воскресенье">Расписание не заполнено</p>
                    </div>
                </div>
            </div>
            
        </div>

        <!-- 2. NOTES VIEW (П.5 - Заметки) -->
        <div id="notes-view" class="content-view">
            <h2>Ваши заметки <span style="font-size:0.8rem; color:#888;">(<span id="userEmailNotes"></span>)</span></h2>
            <div style="margin-bottom: 20px;">
                <input type="text" id="noteTitle" placeholder="Заголовок новой заметки">
                <textarea id="noteContent" placeholder="Текст заметки"></textarea>
                <button id="saveNoteButton" class="edit-btn" style="position: static; margin-top: 0; background-color: #5cb85c;">Сохранить заметку</button>
                <p id="noteMessage" style="color: red; margin-top: 10px;"></p>
            </div>

            <h3>Сохраненные заметки</h3>
            <div id="savedNotesList">
                <p style="color:#888;">Здесь будут отображаться ваши заметки.</p>
            </div>
        </div>

        <!-- 3. TRANSLATOR VIEW (П.1 - История переводов) -->
        <div id="translator-view" class="content-view">
            <h2>История переводов</h2>
            <p style="color:#aaa;">Функционал перевода будет добавлен позже. Здесь вы увидите историю ваших запросов.</p>
            <div id="translatorHistoryList">
                <p style="color:#888;">История переводов пуста.</p>
            </div>
        </div>

        <!-- 4. ABOUT VIEW -->
        <div id="about-view" class="content-view">
            <h2>О Neuron Study</h2>
            <div class="day-section">
                <p>Neuron Study — это персональный помощник и планировщик, разработанный в рамках экосистемы Neuron Ecosystem.</p>
                <p>Наша цель — помочь вам эффективно управлять своим временем, расписанием и учебным материалом, предоставляя удобные инструменты для организации информации и доступа к необходимым ресурсам.</p>
                <p><strong>Версия:</strong> 1.0 (с Firebase Firestore)</p>
            </div>
        </div>

    </div>

    <!-- ------------------------------------------------------------- -->
    <!-- MODALS AND SCRIPTS (Placed at the end of the body) -->
    <!-- ------------------------------------------------------------- -->
    
    <!-- 1. AUTH FORM (Modal, hidden by default) -->
    <div id="auth-container">
        <h2>Вход / Регистрация в Neuron Study</h2>
        <input type="email" id="emailInput" placeholder="Введите email">
        <input type="password" id="passwordInput" placeholder="Введите пароль">
        <button id="registerButton">Зарегистрироваться</button>
        <button id="loginButton">Войти</button>
        <button id="installBtn" style="display: none;">Установить приложение</button>
        <p id="authMessage" style="color: red;"></p>
        <button id="closeAuthButton" class="close-btn">&times;</button>
    </div>

    <!-- 2. SCHEDULE EDITOR MODAL (П.4 - Редактирование расписания) -->
    <div id="schedule-editor-modal" style="display:none; position:fixed; top:50%; left:50%; transform:translate(-50%, -50%); background:#1e1e2d; padding:20px; border-radius:10px; z-index:3000; box-shadow:0 0 20px rgba(255, 255, 255, 0.2); max-width: 500px; width: 90%;">
        <h3 id="editor-title" style="color: var(--secondary);">Редактирование расписания на [День]</h3>
        <textarea id="scheduleTextarea" rows="10" style="width: 100%; padding: 10px; margin-bottom: 15px; background: #2b2b3b; border: 1px solid #444; color: var(--text-color); border-radius: 5px;"></textarea>
        <button id="saveScheduleEdit" style="background-color: var(--primary); color: white; padding: 10px 15px; border: none; border-radius: 5px; margin-right: 10px;">Сохранить</button>
        <button id="closeScheduleEdit" style="background-color: #555; color: white; padding: 10px 15px; border: none; border-radius: 5px;">Отмена</button>
    </div>
    
    <!-- FIREBASE INITIALIZATION AND APP LOGIC -->
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-auth.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-firestore.js"></script>

    <script defer>
        // YOUR FIREBASE CONFIGURATION DATA
        const firebaseConfig = {
            apiKey: "AIzaSyDOaDVzzPjyYm4HWMND2XYWjLy_h4wty5s",
            authDomain: "neuron-ecosystem-2025.firebaseapp.com",
            projectId: "neuron-ecosystem-2025",
            storageBucket: "neuron-ecosystem-2025.firebasestorage.app",
            messagingSenderId: "589834476565",
            appId: "1:589834476565:web:c9c878a905ecece4dd421c"
        };

        const app = firebase.initializeApp(firebaseConfig);
        const auth = firebase.auth();
        const db = firebase.firestore();
        
        let hasUnsavedChanges = false; // П.2: Флаг для отслеживания изменений анонимного пользователя
        let currentDayToEdit = '';
        const DAYS = ["Понедельник", "Вторник", "Среда", "Четверг", "Пятница", "Суббота", "Воскресенье"];
        let scheduleData = {};
        let notesData = [];

        // --- PWA LOGIC (Service Worker and Install Button) ---
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', function() {
                navigator.serviceWorker.register('sw.js')
                    .then(function(reg) {
                        console.log('Service Worker зарегистрирован:', reg);
                    }).catch(function(err) {
                        console.log('Service Worker registration failed:', err);
                    });
            });
        }
        // ... (PWA install logic is omitted here for brevity, keeping original structure)

        // --- HTML Element References ---
        const authContainer = document.getElementById('auth-container');
        const mainAuthButton = document.getElementById('mainAuthButton');
        const authMessage = document.getElementById('authMessage');
        const closeAuthButton = document.getElementById('closeAuthButton');
        const menuIcon = document.getElementById('menuIcon');
        const navSidebar = document.getElementById('navSidebar');
        const overlay = document.getElementById('overlay');
        const contentViews = document.querySelectorAll('.content-view');
        const sidebarItems = document.querySelectorAll('.sidebar-item');
        const editorModal = document.getElementById('schedule-editor-modal');
        const scheduleTextarea = document.getElementById('scheduleTextarea');
        const editorTitle = document.getElementById('editor-title');
        const savedNotesList = document.getElementById('savedNotesList');
        const userEmailNotes = document.getElementById('userEmailNotes');
        const menuLogout = document.getElementById('menu-logout');
        
        // --- UI UTILITIES ---

        // П.1: Открытие/закрытие боковой панели
        function toggleSidebar() {
            navSidebar.classList.toggle('open');
            overlay.style.display = navSidebar.classList.contains('open') ? 'block' : 'none';
        }

        // П.1: Переключение главного контента
        function showView(viewId) {
            contentViews.forEach(view => {
                view.classList.remove('active');
            });
            document.getElementById(viewId).classList.add('active');
            
            sidebarItems.forEach(item => item.classList.remove('active'));
            document.getElementById(`menu-${viewId.replace('-view', '')}`).classList.add('active');
            
            toggleSidebar(); // Закрыть сайдбар после выбора
        }

        // П.4: Открытие редактора расписания
        window.openScheduleEditor = function(day) {
            currentDayToEdit = day;
            editorTitle.textContent = `Редактирование расписания на ${day}`;
            
            // Загрузка текущего содержимого (из scheduleData или из заглушки)
            const currentContent = scheduleData[day] || document.getElementById(`schedule-${day}`).textContent;
            scheduleTextarea.value = currentContent === 'Расписание не заполнено' ? '' : currentContent;
            
            editorModal.style.display = 'block';
            overlay.style.zIndex = 2500; // Поверх модального окна
            overlay.style.display = 'block';
        };

        function closeScheduleEditor() {
            editorModal.style.display = 'none';
            overlay.style.zIndex = 98;
            overlay.style.display = navSidebar.classList.contains('open') ? 'block' : 'none';
        }

        // --- DATABASE LOGIC (П.2) ---

        // Сохранение расписания в Firestore
        async function saveScheduleToFirestore(userId, data) {
            try {
                await db.collection("artifacts").doc(userId).set({ schedule: data }, { merge: true });
                console.log("Расписание сохранено в Firestore.");
                hasUnsavedChanges = false;
            } catch (error) {
                console.error("Ошибка сохранения расписания:", error);
            }
        }

        // Загрузка данных расписания из Firestore
        function loadDataFromFirestore(user) {
            if (!user) return;
            
            // 1. Расписание
            db.collection("artifacts").doc(user.uid).onSnapshot(doc => {
                if (doc.exists && doc.data().schedule) {
                    scheduleData = doc.data().schedule;
                    updateScheduleUI();
                } else {
                    scheduleData = {};
                    updateScheduleUI();
                }
            }, error => console.error("Ошибка при получении расписания:", error));
            
            // 2. Заметки
            db.collection("artifacts").doc(user.uid).collection("notes").orderBy("createdAt", "desc").onSnapshot(snapshot => {
                notesData = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                renderNotes();
            }, error => console.error("Ошибка при получении заметок:", error));
        }

        // Обновление UI расписания
        function updateScheduleUI() {
            DAYS.forEach(day => {
                const pElement = document.getElementById(`schedule-${day}`);
                if (scheduleData[day] && scheduleData[day].trim()) {
                    pElement.innerHTML = scheduleData[day].replace(/\n/g, '<br>');
                    pElement.style.color = 'white';
                    pElement.parentElement.classList.remove('schedule-placeholder');
                } else {
                    pElement.textContent = 'Расписание не заполнено';
                    pElement.style.color = '#777';
                    pElement.parentElement.classList.add('schedule-placeholder');
                }
            });
        }
        
        // Рендеринг заметок
        function renderNotes() {
            savedNotesList.innerHTML = '';
            if (notesData.length === 0) {
                savedNotesList.innerHTML = '<p style="color:#888;">Заметок пока нет.</p>';
                return;
            }
            notesData.forEach(note => {
                const card = document.createElement('div');
                card.className = 'note-card';
                
                const title = document.createElement('h4');
                title.textContent = note.title || 'Без заголовка';
                
                const content = document.createElement('p');
                content.textContent = note.content;
                
                const date = document.createElement('small');
                if (note.createdAt && note.createdAt.toDate) {
                     date.textContent = 'Создано: ' + note.createdAt.toDate().toLocaleDateString('ru-RU');
                }
                
                card.appendChild(title);
                card.appendChild(content);
                card.appendChild(date);
                savedNotesList.appendChild(card);
            });
        }


        // --- AUTHENTICATION HANDLERS ---
        const handleError = (error) => {
            console.error(error);
            let message = 'Произошла ошибка. Пожалуйста, попробуйте снова.';
            // ... (error handling logic remains the same)
            if (error.code === 'auth/email-already-in-use') { message = 'Этот email уже используется. Попробуйте войти.'; } 
            else if (error.code === 'auth/weak-password') { message = 'Пароль должен содержать не менее 6 символов.'; } 
            else if (error.code === 'auth/invalid-credential' || error.code === 'auth/user-not-found' || error.code === 'auth/wrong-password') { message = 'Неверный email или пароль.'; } 
            else if (error.code === 'auth/invalid-email') { message = 'Неверный формат email.'; }
            
            authMessage.style.color = 'red';
            authMessage.textContent = 'Ошибка: ' + message;
        };
        
        // --- EVENT LISTENERS ---
        
        document.addEventListener('DOMContentLoaded', () => {
            
            // AUTH LISTENERS
            document.getElementById('registerButton').addEventListener('click', () => {
                const emailInput = document.getElementById('emailInput');
                const passwordInput = document.getElementById('passwordInput');
                authMessage.textContent = '';
                auth.createUserWithEmailAndPassword(emailInput.value, passwordInput.value).catch(handleError);
            });

            document.getElementById('loginButton').addEventListener('click', () => {
                const emailInput = document.getElementById('emailInput');
                const passwordInput = document.getElementById('passwordInput');
                authMessage.textContent = '';
                auth.signInWithEmailAndPassword(emailInput.value, passwordInput.value).catch(handleError);
            });

            // Кнопка входа/выхода в шапке
            mainAuthButton.addEventListener('click', () => {
                if (auth.currentUser) {
                    auth.signOut();
                } else {
                    authContainer.style.display = 'block';
                    overlay.style.display = 'block';
                    mainAuthButton.style.display = 'none';
                    authMessage.textContent = '';
                }
            });
            
            // Закрытие модального окна авторизации
            closeAuthButton.addEventListener('click', () => {
                authContainer.style.display = 'none';
                overlay.style.display = navSidebar.classList.contains('open') ? 'block' : 'none';
                mainAuthButton.style.display = 'block';
            });

            // SIDEBAR LISTENERS (П.1)
            menuIcon.addEventListener('click', toggleSidebar);
            overlay.addEventListener('click', toggleSidebar);
            
            sidebarItems.forEach(item => {
                item.addEventListener('click', (e) => {
                    const viewId = e.currentTarget.id.replace('menu-', '') + '-view';
                    if (e.currentTarget.id === 'menu-logout') {
                        auth.signOut();
                    } else {
                        showView(viewId);
                    }
                });
            });
            
            // SCHEDULE EDIT LISTENERS (П.4)
            document.getElementById('closeScheduleEdit').addEventListener('click', closeScheduleEditor);
            
            document.getElementById('saveScheduleEdit').addEventListener('click', async () => {
                scheduleData[currentDayToEdit] = scheduleTextarea.value;
                hasUnsavedChanges = true; 
                updateScheduleUI();
                closeScheduleEditor();
                
                // Сохранение в Firestore, если пользователь авторизован
                if (auth.currentUser) {
                    await saveScheduleToFirestore(auth.currentUser.uid, scheduleData);
                }
            });

            // NOTES SAVE LISTENER (П.5)
            document.getElementById('saveNoteButton').addEventListener('click', async () => {
                const user = auth.currentUser;
                const noteTitle = document.getElementById('noteTitle').value;
                const noteContent = document.getElementById('noteContent').value;
                const noteMsg = document.getElementById('noteMessage');

                if (user) {
                    const data = {
                        title: noteTitle,
                        content: noteContent,
                        createdAt: firebase.firestore.FieldValue.serverTimestamp()
                    };
                    
                    try {
                        await db.collection("artifacts").doc(user.uid).collection("notes").add(data);
                        noteMsg.style.color = 'lightgreen';
                        noteMsg.textContent = "Заметка успешно сохранена!";
                        document.getElementById('noteTitle').value = '';
                        document.getElementById('noteContent').value = '';
                    } catch (error) {
                         noteMsg.style.color = 'red';
                         noteMsg.textContent = "Ошибка сохранения: " + error.message;
                    }

                } else {
                    // Анонимное сохранение в память/локально для предупреждения (П.2)
                    notesData.unshift({ title: noteTitle, content: noteContent, createdAt: new Date() });
                    renderNotes();
                    hasUnsavedChanges = true;
                    noteMsg.style.color = 'orange';
                    noteMsg.textContent = "Заметка сохранена локально. Войдите, чтобы сохранить навсегда!";
                }
            });

            // ON BEFORE UNLOAD LISTENER (П.2)
            window.addEventListener('beforeunload', (e) => {
                // Предупреждаем только анонимных пользователей с изменениями
                if (!auth.currentUser && hasUnsavedChanges) {
                    e.preventDefault();
                    e.returnValue = 'Вы точно хотите покинуть сайт? Внесенные изменения не сохранятся!';
                    return 'Вы точно хотите покинуть сайт? Внесенные изменения не сохранятся!';
                }
            });


            // --- AUTH STATE LISTENER (Слушатель состояния авторизации) ---
            auth.onAuthStateChanged((user) => {
                if (user) {
                    // Пользователь авторизован
                    mainAuthButton.textContent = 'Выйти';
                    menuLogout.style.display = 'block';
                    userEmailNotes.textContent = user.email;

                    loadDataFromFirestore(user); // Загрузка данных
                    hasUnsavedChanges = false; // Сброс флага при входе
                } else {
                    // Пользователь не авторизован (Анонимный)
                    mainAuthButton.textContent = 'Войти / Регистрация';
                    menuLogout.style.display = 'none';
                    userEmailNotes.textContent = 'Аноним';

                    // Если данные есть в памяти (анонимные изменения), показываем их, иначе пустые
                    if (!hasUnsavedChanges) {
                         scheduleData = {};
                         notesData = [];
                    }
                    updateScheduleUI();
                    renderNotes();
                }
                
                // Отображение кнопки авторизации в шапке
                mainAuthButton.style.display = 'block';
                authContainer.style.display = 'none';
                overlay.style.display = navSidebar.classList.contains('open') ? 'block' : 'none';
            });
            
            // Инициализация UI: показываем расписание по умолчанию
            showView('schedule-view');
        });
    </script>
</body>
</html>
